<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szczeg√≥≈Çy posta</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container post-detail">
    <h1 id="title">≈Åadowanie...</h1>

    <div class="post-meta">
        <div class="post-author-detail">
            ‚úçÔ∏è Autor: <span id="author">-</span>
        </div>
        <div class="post-date">
            üìÖ <span id="date">-</span>
        </div>
    </div>

    <div class="post-content" id="content">
        ≈Åadowanie tre≈õci...
    </div>

    <div class="comments-section">
        <h2>üí¨ Komentarze</h2>

        <div class="comment-form">
            <textarea id="commentContent" placeholder="Dodaj komentarz..." rows="3"></textarea>
            <input type="text" id="commentAuthor" placeholder="Twoje imiƒô (opcjonalne)">
            <button onclick="addComment()">Dodaj komentarz</button>
        </div>

        <div id="commentsList">
            <p style="text-align: center; color: #718096;">≈Åadowanie komentarzy...</p>
        </div>
    </div>

    <div class="back-button-container">
        <button onclick="window.location.href='index.html'">
            ‚Üê Powr√≥t do listy
        </button>
    </div>
</div>

<script>
    let currentPostId = null;

    async function loadPost() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        currentPostId = id;

        if (!id) {
            document.getElementById('title').textContent = 'B≈ÇƒÖd';
            document.getElementById('content').textContent = 'Nie podano ID posta';
            return;
        }

        try {
            const res = await fetch(`http://localhost:3000/api/posts/${id}`);

            if (!res.ok) {
                throw new Error(`Nie znaleziono posta (status: ${res.status})`);
            }

            const post = await res.json();

            document.getElementById('title').textContent = post.title;
            document.getElementById('content').textContent = post.content;
            document.getElementById('author').textContent = post.author_name || 'Nieznany';

            if (post.created_at) {
                const date = new Date(post.created_at);
                document.getElementById('date').textContent = date.toLocaleDateString('pl-PL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            loadComments();
        } catch (error) {
            console.error('B≈ÇƒÖd podczas ≈Çadowania posta:', error);
            document.getElementById('title').textContent = '‚ùå B≈ÇƒÖd';
            document.getElementById('content').textContent = error.message;
            document.getElementById('content').style.borderLeftColor = '#e53e3e';
            document.getElementById('content').style.background = '#fff5f5';
        }
    }

    async function loadComments() {
        try {
            const res = await fetch(`http://localhost:3000/api/comments/post/${currentPostId}`);
            const comments = await res.json();

            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';

            if (comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align: center; color: #718096;">Brak komentarzy. BƒÖd≈∫ pierwszy!</p>';
                return;
            }

            comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';

                const commentHeader = document.createElement('div');
                commentHeader.className = 'comment-header';

                const authorSpan = document.createElement('span');
                authorSpan.className = 'comment-author';
                authorSpan.textContent = comment.author_name || 'Anonim';

                const dateSpan = document.createElement('span');
                dateSpan.className = 'comment-date';
                const commentDate = new Date(comment.created_at);
                dateSpan.textContent = commentDate.toLocaleDateString('pl-PL', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                commentHeader.appendChild(authorSpan);
                commentHeader.appendChild(dateSpan);

                const commentContent = document.createElement('div');
                commentContent.className = 'comment-content';
                commentContent.textContent = comment.content;

                commentDiv.appendChild(commentHeader);
                commentDiv.appendChild(commentContent);
                commentsList.appendChild(commentDiv);
            });
        } catch (error) {
            console.error('B≈ÇƒÖd podczas ≈Çadowania komentarzy:', error);
            document.getElementById('commentsList').innerHTML = '<p style="color: #e53e3e;">Nie mo≈ºna za≈Çadowaƒá komentarzy</p>';
        }
    }

    async function addComment() {
        const content = document.getElementById('commentContent').value.trim();
        const authorName = document.getElementById('commentAuthor').value.trim();

        if (!content) {
            alert('Tre≈õƒá komentarza nie mo≈ºe byƒá pusta!');
            return;
        }

        try {
            let authorId = null;

            if (authorName) {
            }

            const res = await fetch('http://localhost:3000/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: content,
                    postId: currentPostId,
                    authorId: authorId
                })
            });

            if (!res.ok) {
                throw new Error('Nie uda≈Ço siƒô dodaƒá komentarza');
            }

            document.getElementById('commentContent').value = '';
            document.getElementById('commentAuthor').value = '';

            loadComments();
        } catch (error) {
            console.error('B≈ÇƒÖd podczas dodawania komentarza:', error);
            alert('Nie uda≈Ço siƒô dodaƒá komentarza. Spr√≥buj ponownie.');
        }
    }

    loadPost();
</script>
</body>
</html>